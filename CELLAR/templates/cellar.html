{% extends "template.html" %} 

{% block body %}
<div data-role="page" id="page_CELLAR"><!-- class="ui-responsive-panel" -->
	<div data-role="header" style="text-align: center;">
		<a data-role="button" data-icon="grid" onclick="javascript:CELLAR.toggleDirectory()" id="index_toggle_directory"
			class="ui-nodisc-icon ui-alt-icon ui-btn ui-icon-grid ui-btn-icon-notext ui-corner-all">폴더</a>
		<h1>{{ config.TITLE }}</h1> 
		<a data-role="button" data-icon="bars" onclick="javascript:CELLAR.toggleMenu()" data-iconpos="right">메뉴</a> 
	</div><!-- /header -->

	<div id="panel_left" data-position="left" data-role="panel" data-display="push" data-theme="b">
		<div class="ui-header" style="border-width: 0px; padding: 0.5em;" >&nbsp;</div>
		<div data-role="listview" id="content_directory" style="margin-top: -1px;" data-inset="true" data-shadow="false"></div>
	</div>

	<div id="panel_right" data-position="right" data-role="panel" data-display="overlay" data-theme="a">
		<ul id="ths_menu" data-role="listview" data-inset="true" data-corners="false" data-shadow="false">
			<li style="border-width: 0px;">
			<div id="user_info" style="margin : 50px auto 20px auto; text-align: center;">
				{% if user.is_authenticated %} 
				<p>안녕하세요 {{user.username}} 님</p> 
				<div>
					<a href="/user/logout" 
						data-ajax="false" data-role="button" data-mini="true" data-inline="true" style="width : 5em;">로그아웃</a>
					<a href="/myinfo" 
						data-ajax="false" data-role="button" data-mini="true" data-inline="true" style="width : 5em;">내 정보</a>
				</div>
				{% else %}
				<div>
					<a href="/user/login" 	
						data-ajax="false" data-role="button" data-mini="true" data-inline="true" style="width : 5em;">로그인</a>
					<a href="/signup" 
						data-ajax="false" data-role="button" data-mini="true" data-inline="true" style="width : 5em;">회원가입</a>
				</div>					  
				{% endif %}
			</div>
			</li>
			{% if isSuper %}
			<li data-icon="gear"><a href="/administrator" id="panel_right_setting" data-ajax="false">자료실 설정</a></li>
			{% endif %}
		    <li data-icon="edit"><a onclick="javascript:CELLAR.popupCreateDir()" id="panel_right_newdir">새 폴더</a></li>
			<li data-icon="arrow-u"><a onclick="javascript:CELLAR.popupUpload()" id="panel_right_upload">업로드</a></li>
			<li data-icon="arrow-d"><a onclick="javascript:CELLAR.dump_cwd()">한꺼번에 다운</a></li>
		</ul>
		
		<div id="copyright" style="position: absolute; bottom: 10px; left: 10px; right: 10px;" class="align_center_flow_vertical">
			<a href="/copyright" data-ajax="false" data-role="button" data-mini="true">저작권 정보</a>
  		</div>
	</div>
	
	{% if not user.is_authenticated and config.LOGIN_CAMPAIGN %}
		{% include 'mod/login_campaign.html' %}
	{% endif %}

	<div id="content_cwd" class="ui-content">
		<div id="field_cwd" class="ths-content-cwd">
		/
		</div>
	</div>
	
	<div id="content_filelist" class="ui-content"></div>

	<div data-role="footer">
	{% include "mod/footer.html" %}
	</div><!-- /footer -->
</div><!-- /page -->

<script type="text/javascript">
var CELLAR = {
	cwd : "/",
	
	tarload : function(target) {
		alert("tarload() of " + target);
	},
	
	toggleDirectory : function() {
		$("#panel_left").panel("toggle");
	},
	
	toggleMenu : function() {
		$("#panel_right").panel("toggle");
	},
	
	browse : function(dir) {
		$.mobile.loading("show", {
				text : "Browsing...",
				textVisible : true
			}
		);
		$.post("/browse", {
			csrfmiddlewaretoken : crsf_token,
			target : dir
		},
		function(data, status) {
			if(status != 'success') {
				console.log("Browsing failed.");
				return;
			}
			var jsonResponse = JSON.parse(data);
			Filelist.fill(dir, jsonResponse["filelist"]); 
			Directree.fill(dir, jsonResponse["directree"]);
			
			if(jsonResponse["directree"]["node"].length > 0) {
				var node = Directree.instance.treeHelper("find", dir);
				node.nodeHelper("expand", true);
			}
			CELLAR.cwd = dir;
			// $("#field_cwd").val(CELLAR.cwd);
			$("#field_cwd").text(CELLAR.cwd);
			$.mobile.loading("hide");
		});
	},
	
	popupCreateDir : function() {
		popupFormText.modal(function(newDirName) {
			Transaction.createDir(CELLAR.cwd, newDirName);	
		});
	},
	
	dragStart_directree : function(event, node) {
		var data = WidgetHelper.getData(node);
		var target = [0, data[0][1]];
		console.log("index dragStart " + "D" + " | " + target[1]);
		event.originalEvent.dataTransfer.setData("target", JSON.stringify(target));
	},
	
	dragStart_filelist : function(event, row) {
		var data = WidgetHelper.getData(row);
		var exts = [];
		if(data[0] == 1) {
			data[1][2].forEach(function(extData) {
				exts.push(extData[0]);
			});	
		}
		var target = [data[0], data[1][1], exts];
		console.log("index dragStart " + target[0] + " | " + target[1]);
		event.originalEvent.dataTransfer.setData("target", JSON.stringify(target));
	},
	
	/*
	 * [유형, 식별자, [자식]]
	 */
	drop_on_directree : function(event, node) {
		event.preventDefault();
		var dstPath	= WidgetHelper.getData(node)[0][1];
		var target 	= JSON.parse(event.originalEvent.dataTransfer.getData("target"));
		console.log("index dropOn " + target[0] + " | " + target[1]);
		if(target[0] == 0) {
			// 디렉토리 인 경우
			Transaction.moveDir(target[1], dstPath);
		}
		else {
			// 파일 인 경우
			Transaction.moveFile(target[1], target[2], dstPath);
		}
	},
	
	dump_cwd : function() {
		var params	= "";
		var files	= Filelist.get(1);
		if(files.length == 0) {
			return;
		}
		var path	= CELLAR.cwd;
		params = 'csrfmiddlewaretoken=' + crsf_token;
		params = params + '&path=' + path;
		
		var target = [];
		for(var i = 0; i < files.length; i++) {
			var file = files[i];
			for(var j = 0; j < file[2].length; j++) {
				target.push(file[0] + file[2][j]);
				console.log("DUMP " + path + file[0] + file[2][j][0]);
				params = params + "&files[]=" + file[0] + file[2][j][0];
			}
		}
		
		var filename = "CELLAR.tar";
		var dirs = path.split("/");
		for(var i = dirs.length - 1; i >= 0; i--) {
		    if(dirs[i] == "") continue;
		    
		    filename = dirs[i] + ".tar";
		    break;
		}
		
		Sonien.download('/tarload/' + filename, params, 'post');
	},
	
	onPanelUpdate : function(event, ui) {
		console.log("onPanelUpdate");
		if(Filelist.writeable) {
			$("#panel_right_newdir").show();
			$("#panel_right_upload").show();
			// $("#panel_right_upload > #cwd").val(CELLAR.cwd);
		}
		else {
			$("#panel_right_newdir").hide();
			$("#panel_right_upload").hide();
		}
	},
	
	popupUpload : function() {
		window.history.pushState({needRefresh : true} , "", "/module/upload");
		CELLAR.toggleMenu();
		$( ":mobile-pagecontainer" ).pagecontainer("change", "/module/upload", { 
			type		: "post",
			data		: { cwd 				: CELLAR.cwd, 
							csrfmiddlewaretoken : '{{csrf_token}}' },
			role		: "dialog",
			transition	: "slidedown",
			closeBtn	: "right"
		});
	},
}

//Bind to the navigate event
$( window ).on( "navigate", function( event, data ) {
	if(data.state.needRefresh) {
		Filelist.browse(CELLAR.cwd);
	}
	window.history.pushState({needRefresh : false} , "", "/");
	
	if($(window).width() >= 800) {
		$("#panel_left").panel("open");
	}
});

console.log("CELLAR.Filelist - Start loading");
$("#content_filelist").load(
	"/module/filelist", 
	function(response, status, xhr) {
		if(status == "success") {
			Filelist.setOnClickDirectoryListener(CELLAR.browse);
			Filelist.setOnDragStartListener(CELLAR.dragStart_filelist);	
			console.log("CELLAR.Filelist - Loading success");
		}
		else {
			console.log("CELLAR.Filelist - " + xhr.status + " " + xhr.statusText  );
		}
	});

console.log("CELLAR.Directree - Start loading");
$("#content_directory").load(
	"/module/directree", 
	function(response, status, xhr) {
		if(status == "success") {
			Directree.setOnClickDirectoryListener(CELLAR.browse);
			Directree.setOnDragStartListener(CELLAR.dragStart_directree);
			Directree.setOnDropListener(CELLAR.drop_on_directree);
			console.log("CELLAR.Directree - Loading success");
		}
		else {
			console.log("CELLAR.Directree - " + xhr.status + " " + xhr.statusText  );
		}
	});

$("#panel_right").on("panelbeforeopen", CELLAR.onPanelUpdate);
$("#panel_right").on("panelclose", function(event, ui) {
	var windowWidth = $(window).width();	
	if(windowWidth >= 800) {
		$("#panel_left").panel("open");
	}
});
$(window).on("throttledresize", function(event) {
	var panelLeft 		= $("#panel_left");
	var panelLeftButton	= $("#index_toggle_directory");
	var windowWidth		= event.target.innerWidth; 
	
	var panelLeftDisplay = panelLeft.panel("option", "display");
	console.log("display : " + panelLeftDisplay);
	if(windowWidth >= 600) {
		if(panelLeftDisplay != "push") {
			panelLeft.panel("option", "display", "push");
			panelLeft.panel("option", "dismissible", "false");
		}
	}
	else {
		if(panelLeftDisplay != "overlay") {
			panelLeft.panel("close");
			panelLeft.panel("option", "display", "overlay");
			panelLeft.panel("option", "dismissible", "true");
		}
	}
	
	if(windowWidth >= 800) {
		panelLeftButton.hide();	
		panelLeft.panel("open");
	}
	else {
		panelLeftButton.show()
	}
	console.log("너비 " + windowWidth);
});

$("#page_CELLAR").on("pagecreate", function(event, ui) {
	$(window).trigger("throttledresize");
	
	/* Left Pannel ESC 키 닫기 방지 */
	$(document).unbind("keyup.panel");
	$(document).on("keyup.panel", function( e ) {
		var panelRight = $("#panel_right");
		if ( e.keyCode === 27 && panelRight.hasClass("ui-panel-open") ) {
			panelRight.panel("close");
		}
	});
});
</script>
{% endblock %}
